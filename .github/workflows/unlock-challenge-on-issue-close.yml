name: ğŸ”“ Universal Challenge Unlock

on:
  issues:
    types: [closed]

permissions:
  issues: write
  contents: write

jobs:
  unlock-challenge:
    # Trigger nur bei Challenge Error Reports
    if: |
      contains(github.event.issue.labels.*.name, 'challenge-error') ||
      contains(github.event.issue.title, 'Challenge Error Report') ||
      contains(github.event.issue.body, 'ğŸš¨ Challenge Error Report') ||
      contains(github.event.issue.body, '**ID:**')
    
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Repository auschecken
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ” Challenge-ID Universal Extraktion
        id: extract_id
        run: |
          echo "ğŸ” Starte universelle Challenge-ID Extraktion..."
          
          # Issue-Body sicher in Variable laden
          ISSUE_BODY='${{ github.event.issue.body }}'
          
          echo "ğŸ“„ Issue-Body LÃ¤nge: ${#ISSUE_BODY} Zeichen"
          
          # Methode 1: **ID:** Pattern (Standard Format)
          echo "ğŸ§ª Methode 1: **ID:** Pattern"
          ID1=$(echo "$ISSUE_BODY" | grep -oE '\*\*ID:\*\*[[:space:]]*[a-zA-Z0-9._-]+' | sed 's/.*\*\*ID:\*\*[[:space:]]*//' | head -1 | tr -d ' \t\n\r' 2>/dev/null || echo "")
          echo "   Gefunden: '$ID1'"
          
          # Methode 2: ID: Pattern (ohne Markdown)
          echo "ğŸ§ª Methode 2: ID: Pattern"
          ID2=$(echo "$ISSUE_BODY" | grep -E '^[[:space:]]*ID:[[:space:]]*[a-zA-Z0-9._-]+' | sed 's/.*ID:[[:space:]]*//' | head -1 | tr -d ' \t\n\r' 2>/dev/null || echo "")
          echo "   Gefunden: '$ID2'"
          
          # Methode 3: mcbt Pattern (Challenge-ID Format)
          echo "ğŸ§ª Methode 3: mcbt Pattern"
          ID3=$(echo "$ISSUE_BODY" | grep -oE '[a-zA-Z0-9-]+mcbt[a-zA-Z0-9]+' | head -1 | tr -d ' \t\n\r' 2>/dev/null || echo "")
          echo "   Gefunden: '$ID3'"
          
          # Methode 4: Generisches Challenge-ID Pattern (mit Bindestrichen)
          echo "ğŸ§ª Methode 4: Generic Challenge Pattern"
          ID4=$(echo "$ISSUE_BODY" | grep -oE '[a-z][a-z0-9-]{10,50}[a-z0-9]' | grep -E '.*-.*-.*' | head -1 | tr -d ' \t\n\r' 2>/dev/null || echo "")
          echo "   Gefunden: '$ID4'"
          
          # Methode 5: Suche nach allem zwischen AnfÃ¼hrungszeichen nach "ID"
          echo "ğŸ§ª Methode 5: Quoted ID Pattern"
          ID5=$(echo "$ISSUE_BODY" | grep -oE 'ID[[:space:]]*[:\"]\*\*[[:space:]]*[a-zA-Z0-9._-]+' | sed 's/.*[[:space:]]//' | tr -d '"*: \t\n\r' 2>/dev/null || echo "")
          echo "   Gefunden: '$ID5'"
          
          # Bestimme die beste ID
          FINAL_ID=""
          
          # PrioritÃ¤t: ID1 > ID3 > ID2 > ID4 > ID5
          if [ -n "$ID1" ]; then
            FINAL_ID="$ID1"
            echo "âœ… Verwende ID aus Methode 1: $FINAL_ID"
          elif [ -n "$ID3" ]; then
            FINAL_ID="$ID3"
            echo "âœ… Verwende ID aus Methode 3: $FINAL_ID"
          elif [ -n "$ID2" ]; then
            FINAL_ID="$ID2"
            echo "âœ… Verwende ID aus Methode 2: $FINAL_ID"
          elif [ -n "$ID4" ]; then
            FINAL_ID="$ID4"
            echo "âœ… Verwende ID aus Methode 4: $FINAL_ID"
          elif [ -n "$ID5" ]; then
            FINAL_ID="$ID5"
            echo "âœ… Verwende ID aus Methode 5: $FINAL_ID"
          fi
          
          # Validierung
          if [ -z "$FINAL_ID" ]; then
            echo "âŒ Keine Challenge-ID gefunden!"
            echo ""
            echo "ğŸ” Debug: Issue-Body Inhalt (erste 500 Zeichen):"
            echo "$ISSUE_BODY" | head -c 500
            echo ""
            echo "ğŸ’¡ Erwartete Formate:"
            echo "   - **ID:** challenge-id-hier"
            echo "   - ID: challenge-id-hier"
            echo "   - Beliebiger Text mit challenge-id-mcbtXXXX"
            exit 1
          fi
          
          # ID bereinigen (fÃ¼r Sicherheit)
          CLEAN_ID=$(echo "$FINAL_ID" | tr -cd 'a-zA-Z0-9._-')
          
          if [ "$CLEAN_ID" != "$FINAL_ID" ]; then
            echo "âš ï¸ ID bereinigt: '$FINAL_ID' â†’ '$CLEAN_ID'"
            FINAL_ID="$CLEAN_ID"
          fi
          
          echo "ğŸ¯ Finale Challenge-ID: $FINAL_ID"
          echo "challenge_id=$FINAL_ID" >> $GITHUB_OUTPUT
      
      - name: âœ… Challenge-Existenz prÃ¼fen
        id: validate
        run: |
          ID=${{ steps.extract_id.outputs.challenge_id }}
          CHALLENGE_DIR="challenges/$ID"
          CONFIG_FILE="$CHALLENGE_DIR/challenge.json"
          
          echo "ğŸ” PrÃ¼fe Challenge-Existenz..."
          echo "ğŸ“ Challenge-Verzeichnis: $CHALLENGE_DIR"
          echo "ğŸ“„ Config-Datei: $CONFIG_FILE"
          
          # PrÃ¼fe ob Challenges-Ordner existiert
          if [ ! -d "challenges" ]; then
            echo "âŒ Challenges-Hauptordner existiert nicht!"
            echo "ğŸ“ Repository-Struktur:"
            ls -la
            exit 1
          fi
          
          # PrÃ¼fe ob Challenge-Ordner existiert
          if [ ! -d "$CHALLENGE_DIR" ]; then
            echo "âŒ Challenge-Ordner nicht gefunden: $CHALLENGE_DIR"
            echo ""
            echo "ğŸ“ VerfÃ¼gbare Challenges (erste 10):"
            find challenges/ -maxdepth 1 -type d -name "*" | head -10 || echo "Keine Challenge-Ordner gefunden"
            echo ""
            echo "ğŸ” Suche nach Ã¤hnlichen IDs:"
            find challenges/ -maxdepth 1 -type d -name "*${ID:0:10}*" 2>/dev/null || echo "Keine Ã¤hnlichen IDs gefunden"
            exit 1
          fi
          
          # PrÃ¼fe ob Config-Datei existiert
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ Challenge-Konfiguration nicht gefunden: $CONFIG_FILE"
            echo ""
            echo "ğŸ“ Ordner-Inhalt:"
            ls -la "$CHALLENGE_DIR/"
            exit 1
          fi
          
          echo "âœ… Challenge existiert und ist gÃ¼ltig"
          
          # Aktuellen Status auslesen (falls mÃ¶glich)
          if command -v jq >/dev/null 2>&1; then
            CURRENT_STATUS=$(jq -r '.status // "unknown"' "$CONFIG_FILE" 2>/dev/null || echo "unknown")
            echo "ğŸ“Š Aktueller Status: $CURRENT_STATUS"
            echo "current_status=$CURRENT_STATUS" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ jq nicht verfÃ¼gbar - Status-Check Ã¼bersprungen"
            echo "current_status=unknown" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ”§ Challenge-Status zurÃ¼cksetzen
        run: |
          ID=${{ steps.extract_id.outputs.challenge_id }}
          CONFIG_FILE="challenges/$ID/challenge.json"
          
          echo "ğŸ› ï¸ Setze Challenge-Status zurÃ¼ck..."
          echo "ğŸ“„ Datei: $CONFIG_FILE"
          
          # Backup erstellen
          cp "$CONFIG_FILE" "$CONFIG_FILE.backup"
          echo "ğŸ’¾ Backup erstellt: $CONFIG_FILE.backup"
          
          # Status zurÃ¼cksetzen mit sed (funktioniert ohne jq)
          echo "ğŸ”§ Aktualisiere Status-Felder..."
          
          # Status auf approved setzen
          sed -i 's/"status"[[:space:]]*:[[:space:]]*"[^"]*"/"status": "approved"/g' "$CONFIG_FILE"
          
          # Fehler-Flags entfernen/zurÃ¼cksetzen
          sed -i 's/"hasErrors"[[:space:]]*:[[:space:]]*true/"hasErrors": false/g' "$CONFIG_FILE"
          sed -i 's/"isHidden"[[:space:]]*:[[:space:]]*true/"isHidden": false/g' "$CONFIG_FILE"
          
          # Gemeldete Issue-Referenzen entfernen
          sed -i '/"reportedIssueNumber"/d' "$CONFIG_FILE"
          sed -i '/"reportedIssueUrl"/d' "$CONFIG_FILE"
          sed -i '/"errorReport"/d' "$CONFIG_FILE"
          
          # ZusÃ¤tzliche Bereinigung fÃ¼r mÃ¶gliche andere Status-Werte
          sed -i 's/"status"[[:space:]]*:[[:space:]]*"reported"/"status": "approved"/g' "$CONFIG_FILE"
          sed -i 's/"status"[[:space:]]*:[[:space:]]*"pending"/"status": "approved"/g' "$CONFIG_FILE"
          sed -i 's/"status"[[:space:]]*:[[:space:]]*"rejected"/"status": "approved"/g' "$CONFIG_FILE"
          
          echo "âœ… Status-Update abgeschlossen"
          
          # Validierung (falls jq verfÃ¼gbar)
          if command -v jq >/dev/null 2>&1; then
            if jq . "$CONFIG_FILE" >/dev/null 2>&1; then
              NEW_STATUS=$(jq -r '.status' "$CONFIG_FILE" 2>/dev/null || echo "unknown")
              echo "ğŸ“Š Neuer Status: $NEW_STATUS"
            else
              echo "âš ï¸ JSON-Validation fehlgeschlagen - verwende Backup"
              mv "$CONFIG_FILE.backup" "$CONFIG_FILE"
              exit 1
            fi
          fi
          
          echo "ğŸ“„ Neue DateigrÃ¶ÃŸe: $(wc -c < "$CONFIG_FILE") bytes"
      
      - name: ğŸ“ Error-Report aktualisieren (optional)
        run: |
          ID=${{ steps.extract_id.outputs.challenge_id }}
          ERROR_FILE="challenges/$ID/error-report.json"
          
          if [ -f "$ERROR_FILE" ]; then
            echo "ğŸ“ Aktualisiere Error-Report: $ERROR_FILE"
            
            # Einfache sed-basierte Aktualisierung
            sed -i 's/"isResolved"[[:space:]]*:[[:space:]]*false/"isResolved": true/g' "$ERROR_FILE"
            
            # Falls jq verfÃ¼gbar, erweiterte Aktualisierung
            if command -v jq >/dev/null 2>&1; then
              TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
              jq --arg timestamp "$TIMESTAMP" --argjson issue "${{ github.event.issue.number }}" '
                .isResolved = true |
                .resolvedAt = $timestamp |
                .resolvedBy = "github-action" |
                .resolvedIssue = $issue
              ' "$ERROR_FILE" > "$ERROR_FILE.tmp" && mv "$ERROR_FILE.tmp" "$ERROR_FILE"
              echo "âœ… Error-Report mit jq aktualisiert"
            else
              echo "â„¹ï¸ Error-Report mit sed aktualisiert"
            fi
          else
            echo "â„¹ï¸ Kein Error-Report gefunden: $ERROR_FILE"
          fi
      
      - name: ğŸ’¾ Git-Konfiguration und Commit
        run: |
          ID=${{ steps.extract_id.outputs.challenge_id }}
          
          # Git konfigurieren
          git config user.name "challenge-unlock-bot"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          echo "ğŸ” PrÃ¼fe auf Ã„nderungen..."
          
          if git diff --quiet; then
            echo "â„¹ï¸ Keine Ã„nderungen zu committen"
          else
            echo "ğŸ“ Committen der Ã„nderungen..."
            
            # Nur die Challenge-Dateien hinzufÃ¼gen
            git add "challenges/$ID/"
            
            # Commit mit aussagekrÃ¤ftiger Nachricht
            git commit -m "ğŸ”“ Challenge automatisch entsperrt: $ID

Entsperrt nach Issue-SchlieÃŸung #${{ github.event.issue.number }}
âœ… Status: approved
ğŸ—“ï¸ Entsperrt: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
ğŸ¤– Automatisch durch GitHub Actions

Co-authored-by: ${{ github.event.issue.user.login }} <${{ github.event.issue.user.id }}+${{ github.event.issue.user.login }}@users.noreply.github.com>"
            
            echo "ğŸ“¤ Push der Ã„nderungen..."
            git push origin main
            
            echo "âœ… Challenge $ID erfolgreich entsperrt und gepusht"
          fi
      
      - name: ğŸ’¬ Erfolgs-Kommentar hinzufÃ¼gen
        uses: actions/github-script@v7
        with:
          script: |
            const challengeId = '${{ steps.extract_id.outputs.challenge_id }}';
            const currentStatus = '${{ steps.validate.outputs.current_status }}' || 'unknown';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âœ… Challenge automatisch entsperrt!
              
              **ğŸ¯ Challenge-ID:** \`${challengeId}\`  
              **ğŸ“Š Vorheriger Status:** \`${currentStatus}\`  
              **ğŸ“Š Neuer Status:** \`approved\`  
              **ğŸ•’ Entsperrt:** ${new Date().toLocaleString('de-DE', {timeZone: 'Europe/Berlin'})}
              
              ### ğŸ‰ Was ist passiert:
              - âœ… Challenge-Status wurde auf \`approved\` zurÃ¼ckgesetzt
              - ğŸ”“ Challenge ist wieder fÃ¼r alle Benutzer sichtbar  
              - ğŸ“ Error-Report als gelÃ¶st markiert
              - ğŸ—‘ï¸ Fehler-Flags und Issue-Referenzen entfernt
              
              ### ğŸš€ NÃ¤chste Schritte:
              Die Challenge \`${challengeId}\` ist jetzt wieder verfÃ¼gbar und kann in der **VS Code Coding Challenges Extension** geladen werden.
              
              ---
              ğŸ¤– *Automatisch entsperrt durch GitHub Actions*`
            });
            
            console.log('âœ… Erfolgs-Kommentar hinzugefÃ¼gt');
      
      - name: ğŸ·ï¸ Issue-Labels aktualisieren
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // Labels hinzufÃ¼gen
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: ['resolved', 'auto-unlocked', 'challenge-restored']
              });
              
              console.log('âœ… Labels hinzugefÃ¼gt: resolved, auto-unlocked, challenge-restored');
            } catch (error) {
              console.error('âš ï¸ Fehler beim HinzufÃ¼gen der Labels:', error);
            }

  # Fehlerbehandlung
  handle-failure:
    if: failure()
    needs: unlock-challenge
    runs-on: ubuntu-latest
    permissions:
      issues: write
    
    steps:
      - name: ğŸ’¬ Detaillierter Fehler-Kommentar
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âŒ Automatische Challenge-Entsperrung fehlgeschlagen
              
              Der Versuch, die Challenge automatisch zu entsperren, ist fehlgeschlagen.
              
              ### ğŸ› ï¸ Manuelle Schritte erforderlich:
              
              #### 1. Challenge-ID finden
              Suche im Issue-Body nach der Challenge-ID (Format: \`**ID:** challenge-id-hier\`)
              
              #### 2. Datei bearbeiten
              Ã–ffne die Datei: \`challenges/{challenge-id}/challenge.json\`
              
              #### 3. Status Ã¤ndern
              Ã„ndere folgende Werte:
              \`\`\`json
              {
                "status": "approved",
                "hasErrors": false,
                "isHidden": false
              }
              \`\`\`
              
              #### 4. Referenzen entfernen
              LÃ¶sche diese Zeilen (falls vorhanden):
              \`\`\`json
              "reportedIssueNumber": ${context.issue.number},
              "reportedIssueUrl": "...",
              "errorReport": { ... }
              \`\`\`
              
              #### 5. Speichern
              Committe und pushe die Ã„nderungen
              
              ### ğŸ” Debugging-Informationen:
              - **Issue:** #${context.issue.number}
              - **Workflow-Run:** [${context.runId}](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              - **Fehler-Zeit:** ${new Date().toISOString()}
              
              ### ğŸ“‹ HÃ¤ufige Ursachen:
              - Challenge-ID konnte nicht aus Issue-Body extrahiert werden
              - Challenge-Ordner existiert nicht im Repository
              - Datei-Permissions oder Git-Fehler
              - JSON-Format ungÃ¼ltig
              
              **ğŸ’¡ Tipp:** PrÃ¼fe die Workflow-Logs fÃ¼r detaillierte Fehlermeldungen.
              
              ---
              ğŸ¤– *Fehlerbehandlung - Manuelle Aktion erforderlich*`
            });
            
            // Fehler-Labels hinzufÃ¼gen
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['manual-unlock-required', 'auto-unlock-failed']
            });
            
            console.log('âœ… Fehler-Kommentar und Labels hinzugefÃ¼gt');
