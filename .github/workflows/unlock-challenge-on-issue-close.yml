name: ğŸ”“ Unlock Challenge bei Issue-SchlieÃŸung

on:
  issues:
    types: [closed]

jobs:
  unlock-challenge:
    # Nur ausfÃ¼hren wenn Issue das Label 'challenge-error' hat
    if: contains(github.event.issue.labels.*.name, 'challenge-error')
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Repository auschecken
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ğŸ” Challenge-ID aus Issue extrahieren
        id: extract
        run: |
          echo "ğŸ“„ Analysiere Issue-Body..."
          
          # Issue-Body in Datei speichern
          cat << 'EOF' > issue_body.txt
          ${{ github.event.issue.body }}
          EOF
          
          echo "ğŸ” Suche Challenge-ID im Issue-Body..."
          
          # Verschiedene Muster versuchen:
          # 1. **ID:** w-rter-in-matrix-finden-mcbt2g3d
          ID=$(grep -E '\*\*ID:\*\*' issue_body.txt | sed 's/.*\*\*ID:\*\*[[:space:]]*//' | head -1 | xargs)
          
          # 2. Fallback: ID: (ohne Markdown)
          if [ -z "$ID" ]; then
            ID=$(grep -E '^ID:' issue_body.txt | cut -d ':' -f2 | xargs)
          fi
          
          # 3. Fallback: **Challenge:** titel **ID:** id
          if [ -z "$ID" ]; then
            ID=$(grep -oE '\*\*ID:\*\*[[:space:]]*[a-zA-Z0-9_-]+' issue_body.txt | sed 's/.*\*\*ID:\*\*[[:space:]]*//')
          fi
          
          # 4. Letzter Fallback: Extrahiere aus Titel (weniger zuverlÃ¤ssig)
          if [ -z "$ID" ]; then
            echo "âš ï¸ Keine direkte ID gefunden, versuche Extraktion aus Issue-Titel..."
            # Hier kÃ¶nnte man versuchen aus dem Issue-Titel zu extrahieren
            echo "Issue-Titel: ${{ github.event.issue.title }}"
          fi
          
          if [ -z "$ID" ]; then
            echo "âŒ Keine Challenge-ID gefunden!"
            echo "ğŸ“‹ Issue-Body Inhalt:"
            cat issue_body.txt
            echo ""
            echo "ğŸ’¡ Erwartetes Format: **ID:** challenge-id-hier"
            exit 1
          fi
          
          echo "âœ… Challenge-ID gefunden: $ID"
          echo "challenge_id=$ID" >> $GITHUB_OUTPUT
          
          # Bereinige temporÃ¤re Datei
          rm issue_body.txt
      
      - name: âœ… PrÃ¼fe ob Challenge existiert
        id: check
        run: |
          ID=${{ steps.extract.outputs.challenge_id }}
          CHALLENGE_DIR="challenges/$ID"
          CONFIG_FILE="$CHALLENGE_DIR/challenge.json"
          
          if [ ! -d "$CHALLENGE_DIR" ]; then
            echo "âŒ Challenge-Ordner nicht gefunden: $CHALLENGE_DIR"
            exit 1
          fi
          
          if [ ! -f "$CONFIG_FILE" ]; then
            echo "âŒ Challenge-Konfiguration nicht gefunden: $CONFIG_FILE"
            exit 1
          fi
          
          echo "âœ… Challenge existiert: $CONFIG_FILE"
          
          # Aktueller Status prÃ¼fen
          CURRENT_STATUS=$(jq -r '.status // "unknown"' "$CONFIG_FILE")
          echo "ğŸ“Š Aktueller Status: $CURRENT_STATUS"
          echo "current_status=$CURRENT_STATUS" >> $GITHUB_OUTPUT
      
      - name: ğŸ”§ Challenge-Status zurÃ¼cksetzen
        run: |
          ID=${{ steps.extract.outputs.challenge_id }}
          CONFIG_FILE="challenges/$ID/challenge.json"
          
          echo "ğŸ› ï¸ Setze Challenge-Status zurÃ¼ck in: $CONFIG_FILE"
          
          # Erstelle Backup
          cp "$CONFIG_FILE" "$CONFIG_FILE.backup"
          
          # Status zurÃ¼cksetzen mit jq
          jq '
            .status = "approved" |
            .hasErrors = false |
            .isHidden = false |
            del(.reportedIssueNumber) |
            del(.reportedIssueUrl) |
            del(.errorReport) |
            .lastUpdated = now | strftime("%Y-%m-%dT%H:%M:%SZ")
          ' "$CONFIG_FILE" > "$CONFIG_FILE.tmp" && mv "$CONFIG_FILE.tmp" "$CONFIG_FILE"
          
          echo "âœ… Challenge-Status aktualisiert"
          echo "ğŸ“‹ Neuer Inhalt:"
          jq . "$CONFIG_FILE"
      
      - name: ğŸ“ Error-Report als gelÃ¶st markieren
        run: |
          ID=${{ steps.extract.outputs.challenge_id }}
          ERROR_FILE="challenges/$ID/error-report.json"
          
          if [ -f "$ERROR_FILE" ]; then
            echo "ğŸ“ Markiere Error-Report als gelÃ¶st: $ERROR_FILE"
            
            # Error-Report aktualisieren
            jq '
              .isResolved = true |
              .resolvedAt = now | strftime("%Y-%m-%dT%H:%M:%SZ") |
              .resolvedBy = "github-action" |
              .resolvedIssue = ${{ github.event.issue.number }}
            ' "$ERROR_FILE" > "$ERROR_FILE.tmp" && mv "$ERROR_FILE.tmp" "$ERROR_FILE"
            
            echo "âœ… Error-Report aktualisiert"
          else
            echo "â„¹ï¸ Kein Error-Report gefunden ($ERROR_FILE)"
          fi
      
      - name: ğŸ¯ Git-Konfiguration setzen
        run: |
          git config user.name "Challenge-Unlock-Bot"
          git config user.email "action@github.com"
      
      - name: ğŸ’¾ Ã„nderungen committen
        run: |
          ID=${{ steps.extract.outputs.challenge_id }}
          
          # Status prÃ¼fen
          if git diff --quiet; then
            echo "â„¹ï¸ Keine Ã„nderungen zu committen"
            exit 0
          fi
          
          # Ã„nderungen hinzufÃ¼gen
          git add "challenges/$ID/"
          
          # Commit erstellen
          git commit -m "ğŸ”“ Unlock Challenge '$ID' nach Issue-SchlieÃŸung
          
          âœ… Challenge wieder freigegeben nach Issue #${{ github.event.issue.number }}
          ğŸ“‹ Status: approved
          ğŸ—“ï¸ Freigegeben: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
          ğŸ¤– Automatisch durch GitHub Action"
          
          echo "âœ… Ã„nderungen committet"
      
      - name: â¬†ï¸ Ã„nderungen pushen
        run: |
          echo "ğŸ“¤ Pushe Ã„nderungen zu main branch..."
          git push origin main
          echo "âœ… Ã„nderungen erfolgreich gepusht"
      
      - name: ğŸ’¬ Issue-Kommentar hinzufÃ¼gen
        uses: actions/github-script@v7
        with:
          script: |
            const challengeId = '${{ steps.extract.outputs.challenge_id }}';
            const currentStatus = '${{ steps.check.outputs.current_status }}';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âœ… Challenge automatisch freigegeben!
              
              **Challenge-ID:** \`${challengeId}\`
              **Vorheriger Status:** \`${currentStatus}\`
              **Neuer Status:** \`approved\`
              
              ### ğŸ‰ Was passiert ist:
              - âœ… Challenge-Status wurde auf \`approved\` zurÃ¼ckgesetzt
              - ğŸ”“ Challenge ist wieder fÃ¼r Benutzer sichtbar
              - ğŸ“ Error-Report als gelÃ¶st markiert
              - ğŸ—‘ï¸ Fehler-Flags entfernt
              
              ### ğŸš€ NÃ¤chste Schritte:
              Die Challenge \`${challengeId}\` ist jetzt wieder verfÃ¼gbar und kann in der VS Code Extension geladen werden.
              
              ---
              ğŸ¤– *Automatisch ausgefÃ¼hrt durch GitHub Action*`
            });
            
            console.log('âœ… Kommentar zu Issue hinzugefÃ¼gt');
      
      - name: ğŸ·ï¸ Issue-Labels aktualisieren  
        uses: actions/github-script@v7
        with:
          script: |
            // 'resolved' Label hinzufÃ¼gen
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['resolved', 'auto-fixed']
            });
            
            console.log('âœ… Labels hinzugefÃ¼gt: resolved, auto-fixed');

  # Separater Job fÃ¼r Fehlerbehandlung
  handle-failure:
    if: failure() && contains(github.event.issue.labels.*.name, 'challenge-error')
    runs-on: ubuntu-latest
    needs: unlock-challenge
    
    steps:
      - name: ğŸ’¬ Fehler-Kommentar hinzufÃ¼gen
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## âŒ Automatische Challenge-Freigabe fehlgeschlagen
              
              Der Versuch, diese Challenge automatisch freizugeben, ist fehlgeschlagen.
              
              ### ğŸ› ï¸ Manuelle Schritte erforderlich:
              1. Challenge-ID aus dem Issue-Body extrahieren
              2. \`challenges/{challenge-id}/challenge.json\` bearbeiten
              3. Status auf \`"approved"\` setzen und Fehler-Flags entfernen
              4. Ã„nderungen committen und pushen
              
              ### ğŸ” Debugging-Info:
              - **Issue:** #${context.issue.number}
              - **Workflow-Run:** ${context.runId}
              - **Timestamp:** ${new Date().toISOString()}
              
              Bitte Ã¼berprÃ¼fe den [Workflow-Log](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}) fÃ¼r weitere Details.
              
              ---
              ğŸ¤– *Automatischer Fehlerkommentar*`
            });
            
            // 'manual-action-required' Label hinzufÃ¼gen
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['manual-action-required']
            });
