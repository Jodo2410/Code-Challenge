name: ğŸŸ¢ Unlock Challenge bei Issue-SchlieÃŸung

on:
  issues:
    types: [closed]

jobs:
  unlock:
    if: contains(github.event.issue.labels.*.name, 'challenge-error')
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Repository auschecken
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ” Lese Challenge-ID aus Issue
        id: extract
        run: |
          echo "ğŸ” Analysiere Issue-Body..."

          echo "${{ github.event.issue.body }}" > issue.txt
          ID=$(grep -E '^ID:' issue.txt | cut -d ':' -f2 | xargs)
          echo "Gefundene Challenge-ID: $ID"
          echo "challenge_id=$ID" >> $GITHUB_OUTPUT

      - name: ğŸ”§ Patch challenge.json â†’ status: approved
        run: |
          ID=${{ steps.extract.outputs.challenge_id }}
          FILE="challenges/$ID/challenge.json"

          echo "ğŸ”§ Setze Status zurÃ¼ck in $FILE"
          jq '.status = "approved" | .hasErrors = false | del(.errorReport)' "$FILE" > tmp && mv tmp "$FILE"

      - name: ğŸ”§ Patch error-report.json â†’ isResolved: true
        run: |
          ID=${{ steps.extract.outputs.challenge_id }}
          FILE="challenges/$ID/error-report.json"

          if [ -f "$FILE" ]; then
            echo "ğŸ“ Aktualisiere Fehlerbericht: $FILE"
            jq '.isResolved = true' "$FILE" > tmp && mv tmp "$FILE"
          else
            echo "â„¹ï¸ Kein error-report.json gefunden â€“ Ã¼bersprungen."
          fi

      - name: âœ… Commit & Push Ã„nderungen
        run: |
          git config user.name "GitHub Action"
          git config user.email "action@github.com"

          git checkout -b unlock-${{ steps.extract.outputs.challenge_id }}
          git add challenges/${{ steps.extract.outputs.challenge_id }}
          git commit -m "ğŸ”“ Re-enabled challenge ${{ steps.extract.outputs.challenge_id }} after issue closure"
          git push origin unlock-${{ steps.extract.outputs.challenge_id }}

      - name: ğŸ“¦ Erstelle Pull Request zur Freigabe
        uses: peter-evans/create-pull-request@v5
        with:
          title: "ğŸ”“ Freigabe Challenge: ${{ steps.extract.outputs.challenge_id }}"
          body: |
            Dieses PR aktiviert die Challenge wieder nach manueller Freigabe im Issue #${{ github.event.issue.number }}.
          head: unlock-${{ steps.extract.outputs.challenge_id }}
          base: main
