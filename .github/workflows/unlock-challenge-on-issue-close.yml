name: 🔓 Unlock Challenge bei Issue-Schließung

on:
  issues:
    types: [closed]

jobs:
  unlock:
    if: contains(github.event.issue.labels.*.name, 'challenge-error')
    runs-on: ubuntu-latest

    steps:
      - name: 📦 Repository auschecken
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: 🔍 Challenge-ID aus Issue extrahieren
        id: extract
        run: |
          echo "📄 Lese Issue-Body:"
          echo "${{ github.event.issue.body }}" > issue.txt

          ID=$(grep -E '^ID:' issue.txt | cut -d ':' -f2 | xargs)
          if [ -z "$ID" ]; then
            echo "❌ Keine Challenge-ID gefunden. Format muss sein: ID: fizzbuzz"
            exit 1
          fi

          echo "challenge_id=$ID" >> $GITHUB_OUTPUT

      - name: 🔧 Setze Challenge zurück (status: approved)
        run: |
          ID=${{ steps.extract.outputs.challenge_id }}
          FILE="challenges/$ID/challenge.json"

          echo "🛠️ Bearbeite $FILE"
          jq '.status = "approved" | .hasErrors = false | del(.errorReport)' "$FILE" > tmp && mv tmp "$FILE"

      - name: ✅ Markiere Fehlerbericht als gelöst
        run: |
          ID=${{ steps.extract.outputs.challenge_id }}
          FILE="challenges/$ID/error-report.json"

          if [ -f "$FILE" ]; then
            echo "📝 Aktualisiere Fehlerbericht"
            jq '.isResolved = true' "$FILE" > tmp && mv tmp "$FILE"
          else
            echo "ℹ️ Kein Fehlerbericht gefunden."
          fi

      - name: 🟢 Commit & Push
        run: |
          ID=${{ steps.extract.outputs.challenge_id }}

          git config user.name "GitHub Action"
          git config user.email "action@github.com"
          git checkout -b unlock-$ID

          git add challenges/$ID
          git commit -m "🔓 Unlock Challenge $ID nach Issue-Schließung"
          git push origin unlock-$ID

      - name: 📦 Erstelle Pull Request zur Freigabe
        uses: peter-evans/create-pull-request@v5
        with:
          title: "🔓 Challenge-Freigabe: ${{ steps.extract.outputs.challenge_id }}"
          body: |
            Diese Challenge wurde nach manueller Schließung von Issue #${{ github.event.issue.number }} wieder freigegeben.
          head: unlock-${{ steps.extract.outputs.challenge_id }}
          base: main
