name: ðŸ”“ Auto-Release Challenge on Issue Close

on:
  issues:
    types: [closed]

jobs:
  release-challenge:
    name: ðŸ”“ Release Challenge
    runs-on: ubuntu-latest
    
    # Nur fÃ¼r Issues mit challenge-error Label
    if: contains(github.event.issue.labels.*.name, 'challenge-error')
    
    permissions:
      contents: write
      issues: write
    
    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
      
      - name: ðŸ” Find Challenge by Issue Number
        id: find-challenge
        run: |
          echo "ðŸ” Searching for challenge with issue number: ${{ github.event.issue.number }}"
          
          FOUND_CHALLENGE=""
          FOUND_FOLDER=""
          
          # Durchsuche alle challenge.json Dateien
          for file in challenges/*/challenge.json; do
            if [[ -f "$file" ]]; then
              FOLDER=$(dirname "$file")
              CHALLENGE_ID=$(basename "$FOLDER")
              
              # PrÃ¼fe reportedIssueNumber
              ISSUE_NUM=$(jq -r '.reportedIssueNumber // empty' "$file" 2>/dev/null || echo "")
              TITLE=$(jq -r '.title // empty' "$file" 2>/dev/null || echo "")
              
              echo "Checking: $CHALLENGE_ID (Title: $TITLE, Issue: $ISSUE_NUM)"
              
              if [[ "$ISSUE_NUM" == "${{ github.event.issue.number }}" ]]; then
                echo "âœ… Found matching challenge: $CHALLENGE_ID"
                FOUND_CHALLENGE="$CHALLENGE_ID"
                FOUND_FOLDER="$FOLDER"
                break
              fi
            fi
          done
          
          if [[ -n "$FOUND_CHALLENGE" ]]; then
            echo "challenge_id=$FOUND_CHALLENGE" >> $GITHUB_OUTPUT
            echo "challenge_folder=$FOUND_FOLDER" >> $GITHUB_OUTPUT
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "âŒ No challenge found with issue number ${{ github.event.issue.number }}"
          fi
      
      - name: ðŸ”“ Release Challenge
        if: steps.find-challenge.outputs.found == 'true'
        id: release
        run: |
          CHALLENGE_FOLDER="${{ steps.find-challenge.outputs.challenge_folder }}"
          CHALLENGE_ID="${{ steps.find-challenge.outputs.challenge_id }}"
          CHALLENGE_JSON="$CHALLENGE_FOLDER/challenge.json"
          
          echo "ðŸŽ¯ Releasing challenge: $CHALLENGE_ID"
          echo "ðŸ“ Folder: $CHALLENGE_FOLDER"
          
          if [[ ! -f "$CHALLENGE_JSON" ]]; then
            echo "âŒ Challenge JSON not found: $CHALLENGE_JSON"
            exit 1
          fi
          
          # Backup erstellen
          cp "$CHALLENGE_JSON" "$CHALLENGE_JSON.backup"
          
          # Status auf approved setzen und Issue-Referenzen entfernen
          jq '
            .status = "approved" |
            del(.reportedIssueNumber) |
            del(.reportedIssueUrl) |
            del(.isHidden) |
            .releasedAt = now |
            .releasedBy = "github-automation"
          ' "$CHALLENGE_JSON" > "$CHALLENGE_JSON.tmp" && mv "$CHALLENGE_JSON.tmp" "$CHALLENGE_JSON"
          
          echo "âœ… Challenge status updated to approved"
          
          # Git konfigurieren
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # Ã„nderungen committen
          git add "$CHALLENGE_JSON"
          git commit -m "ðŸ”“ Auto-release challenge: $CHALLENGE_ID

Issue #${{ github.event.issue.number }} closed - Challenge freigegeben
Status: approved âœ…
Released: $(date -u +%Y-%m-%dT%H:%M:%SZ)

Auto-generated by GitHub Actions"
          
          git push
          
          # Challenge-Titel fÃ¼r Kommentar extrahieren
          CHALLENGE_TITLE=$(jq -r '.title' "$CHALLENGE_JSON")
          echo "success=true" >> $GITHUB_OUTPUT
          echo "challenge_title=$CHALLENGE_TITLE" >> $GITHUB_OUTPUT
      
      - name: ðŸ’¬ Success Comment
        if: steps.release.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const challengeId = '${{ steps.find-challenge.outputs.challenge_id }}';
            const challengeTitle = '${{ steps.release.outputs.challenge_title }}';
            
            const body = `## âœ… Challenge automatisch freigegeben

Die Challenge wurde erfolgreich wieder freigegeben!

### ðŸŽ¯ Challenge Details
- **ID:** \`${challengeId}\`
- **Titel:** ${challengeTitle}
- **Status:** \`approved\` âœ…
- **Freigegeben:** ${new Date().toISOString()}

### ðŸš€ VerfÃ¼gbarkeit
Die Challenge ist jetzt wieder:
- âœ… In der Challenge-Liste sichtbar
- âœ… Ladbar durch VS Code Extension
- âœ… VerfÃ¼gbar fÃ¼r alle Benutzer

---
ðŸ¤– *Automatisch freigegeben durch GitHub Actions*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
      
      - name: ðŸ·ï¸ Update Labels
        if: steps.release.outputs.success == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            // 'resolved' Label hinzufÃ¼gen
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['resolved', 'auto-released']
            });
      
      - name: âŒ Challenge Not Found
        if: steps.find-challenge.outputs.found == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const body = `## âŒ Challenge nicht gefunden

Es konnte keine Challenge gefunden werden, die mit Issue #${{ github.event.issue.number }} verknÃ¼pft ist.

### ðŸ” GeprÃ¼ft wurde:
- Alle \`challenge.json\` Dateien im \`challenges/\` Ordner
- \`reportedIssueNumber\` Feld in jeder Challenge

### ðŸ› ï¸ Manuelle Schritte:
1. Challenge-Ordner manuell finden
2. In \`challenge.json\` setzen: \`"status": "approved"\`
3. Entfernen: \`reportedIssueNumber\`, \`reportedIssueUrl\`, \`isHidden\`
4. Ã„nderungen committen

---
ðŸ¤– *GitHub Actions Workflow*`;
            
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });
            
            // 'needs-manual-action' Label hinzufÃ¼gen
            await github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: ['needs-manual-action']
            });
      
      - name: ðŸ§¹ Cleanup
        if: always()
        run: |
          # Backup-Dateien entfernen
          find challenges/ -name "*.backup" -type f -delete 2>/dev/null || true
          find challenges/ -name "*.tmp" -type f -delete 2>/dev/null || true
          
          echo "âœ… Workflow completed"
