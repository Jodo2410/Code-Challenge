name: ğŸ” Debug Issue Information

on:
  issues:
    types: [opened, closed, labeled, unlabeled, edited]

jobs:
  debug-issue:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ” Zeige alle Issue-Informationen
        run: |
          echo "ğŸ” VOLLSTÃ„NDIGE ISSUE DEBUG-INFORMATIONEN"
          echo "================================================"
          echo ""
          echo "ğŸ“‹ Issue Basis-Daten:"
          echo "  Nummer: ${{ github.event.issue.number }}"
          echo "  Titel: ${{ github.event.issue.title }}"
          echo "  State: ${{ github.event.issue.state }}"
          echo "  Action: ${{ github.event.action }}"
          echo "  Author: ${{ github.event.issue.user.login }}"
          echo "  Created: ${{ github.event.issue.created_at }}"
          echo "  Updated: ${{ github.event.issue.updated_at }}"
          echo ""
          
      - name: ğŸ“‹ Zeige Issue Labels
        run: |
          echo "ğŸ“‹ ISSUE LABELS:"
          echo "Raw Labels JSON:"
          echo '${{ toJSON(github.event.issue.labels) }}'
          echo ""
          echo "Label Namen (falls vorhanden):"
          if [ '${{ toJSON(github.event.issue.labels) }}' != '[]' ]; then
            echo '${{ toJSON(github.event.issue.labels) }}' | jq -r '.[].name'
          else
            echo "âŒ Keine Labels gefunden!"
          fi
          echo ""
          
      - name: ğŸ“„ Zeige Issue Body
        run: |
          echo "ğŸ“„ ISSUE BODY:"
          echo "=============="
          cat << 'EOF'
          ${{ github.event.issue.body }}
          EOF
          echo ""
          echo "=============="
          
      - name: ğŸ” Challenge-ID Test-Extraktion
        run: |
          echo "ğŸ” TESTE CHALLENGE-ID EXTRAKTION:"
          echo "================================"
          
          # Issue-Body in Datei speichern
          cat << 'EOF' > issue_body.txt
          ${{ github.event.issue.body }}
          EOF
          
          echo "ğŸ“ Roher Issue-Body gespeichert in issue_body.txt"
          echo ""
          
          # Verschiedene Extraktions-Muster testen:
          echo "ğŸ§ª Test 1: **ID:** Pattern"
          ID1=$(grep -E '\*\*ID:\*\*' issue_body.txt | sed 's/.*\*\*ID:\*\*[[:space:]]*//' | head -1 | xargs || echo "")
          echo "  Gefunden: '$ID1'"
          
          echo "ğŸ§ª Test 2: ID: Pattern (Plain)"
          ID2=$(grep -E '^ID:' issue_body.txt | cut -d ':' -f2 | xargs || echo "")
          echo "  Gefunden: '$ID2'"
          
          echo "ğŸ§ª Test 3: Regex mit oE"
          ID3=$(grep -oE '\*\*ID:\*\*[[:space:]]*[a-zA-Z0-9_-]+' issue_body.txt | sed 's/.*\*\*ID:\*\*[[:space:]]*//' || echo "")
          echo "  Gefunden: '$ID3'"
          
          echo "ğŸ§ª Test 4: Erweiterte Regex"
          ID4=$(echo "${{ github.event.issue.body }}" | grep -oE '\*\*ID:\*\*[[:space:]]*[a-zA-Z0-9_-]+' | sed 's/.*\*\*ID:\*\*[[:space:]]*//' || echo "")
          echo "  Gefunden: '$ID4'"
          
          echo ""
          echo "ğŸ“Š ERGEBNIS:"
          FINAL_ID=""
          if [ -n "$ID1" ]; then FINAL_ID="$ID1"; fi
          if [ -z "$FINAL_ID" ] && [ -n "$ID2" ]; then FINAL_ID="$ID2"; fi
          if [ -z "$FINAL_ID" ] && [ -n "$ID3" ]; then FINAL_ID="$ID3"; fi
          if [ -z "$FINAL_ID" ] && [ -n "$ID4" ]; then FINAL_ID="$ID4"; fi
          
          if [ -n "$FINAL_ID" ]; then
            echo "âœ… Challenge-ID erfolgreich extrahiert: '$FINAL_ID'"
          else
            echo "âŒ Keine Challenge-ID gefunden!"
          fi
          
          rm -f issue_body.txt
          
      - name: ğŸ§ª Workflow-Trigger-Bedingungen testen
        run: |
          echo "ğŸ§ª TESTE WORKFLOW-TRIGGER-BEDINGUNGEN:"
          echo "====================================="
          
          # Test 1: Label 'challenge-error'
          LABEL_CHECK="${{ contains(github.event.issue.labels.*.name, 'challenge-error') }}"
          echo "1. Label 'challenge-error': $LABEL_CHECK"
          
          # Test 2: Titel enthÃ¤lt "Challenge Error Report"
          TITLE_CHECK="${{ contains(github.event.issue.title, 'Challenge Error Report') }}"
          echo "2. Titel enthÃ¤lt 'Challenge Error Report': $TITLE_CHECK"
          
          # Test 3: Body enthÃ¤lt "ğŸš¨ Challenge Error Report"
          BODY_CHECK="${{ contains(github.event.issue.body, 'ğŸš¨ Challenge Error Report') }}"
          echo "3. Body enthÃ¤lt 'ğŸš¨ Challenge Error Report': $BODY_CHECK"
          
          # Test 4: Body enthÃ¤lt "**ID:**"
          ID_CHECK="${{ contains(github.event.issue.body, '**ID:**') }}"
          echo "4. Body enthÃ¤lt '**ID:**': $ID_CHECK"
          
          echo ""
          echo "ğŸ“Š ZUSAMMENFASSUNG:"
          if [ "$LABEL_CHECK" = "true" ] || [ "$TITLE_CHECK" = "true" ] || [ "$BODY_CHECK" = "true" ] || [ "$ID_CHECK" = "true" ]; then
            echo "âœ… Unlock-Workflow SOLLTE ausgefÃ¼hrt werden!"
            echo "   Mindestens eine Bedingung ist erfÃ¼llt."
          else
            echo "âŒ Unlock-Workflow wird NICHT ausgefÃ¼hrt!"
            echo "   Keine der Bedingungen ist erfÃ¼llt."
          fi
          
      - name: ğŸ“¤ Issue-Kommentar mit Debug-Info
        if: github.event.action == 'closed'
        uses: actions/github-script@v7
        with:
          script: |
            const labelCheck = ${{ contains(github.event.issue.labels.*.name, 'challenge-error') }};
            const titleCheck = ${{ contains(github.event.issue.title, 'Challenge Error Report') }};
            const bodyCheck = ${{ contains(github.event.issue.body, 'ğŸš¨ Challenge Error Report') }};
            const idCheck = ${{ contains(github.event.issue.body, '**ID:**') }};
            
            const shouldTrigger = labelCheck || titleCheck || bodyCheck || idCheck;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ” Debug Information fÃ¼r Issue #${context.issue.number}
              
              **Issue geschlossen - Workflow-Trigger-Analyse:**
              
              ### ğŸ§ª Trigger-Bedingungen:
              - âœ… Label 'challenge-error': \`${labelCheck}\`
              - âœ… Titel enthÃ¤lt 'Challenge Error Report': \`${titleCheck}\`
              - âœ… Body enthÃ¤lt 'ğŸš¨ Challenge Error Report': \`${bodyCheck}\`
              - âœ… Body enthÃ¤lt '**ID:**': \`${idCheck}\`
              
              ### ğŸ“Š Ergebnis:
              ${shouldTrigger ? 
                'âœ… **Unlock-Workflow SOLLTE ausgefÃ¼hrt werden**' : 
                'âŒ **Unlock-Workflow wird NICHT ausgefÃ¼hrt**'
              }
              
              ### ğŸ“‹ Labels auf diesem Issue:
              ${context.payload.issue.labels.map(label => \`- \`${label.name}\`\`).join('\\n') || 'Keine Labels gefunden'}
              
              ### ğŸ”— NÃ¼tzliche Links:
              - [Workflow-Runs anzeigen](https://github.com/${context.repo.owner}/${context.repo.repo}/actions)
              - [Debug-Workflow-Run](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})
              
              ---
              ğŸ¤– *Debug-Kommentar vom Issue-Debug-Workflow*`
            });
