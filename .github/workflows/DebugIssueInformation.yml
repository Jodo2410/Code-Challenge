name: ğŸ” Debug Challenge-ID Extraktion

on:
  issues:
    types: [closed, opened, labeled]

permissions:
  issues: write

jobs:
  debug-extraction:
    if: |
      contains(github.event.issue.labels.*.name, 'challenge-error') ||
      contains(github.event.issue.title, 'Challenge Error Report') ||
      contains(github.event.issue.body, 'ğŸš¨ Challenge Error Report')
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¦ Checkout Repository
        uses: actions/checkout@v4
      
      - name: ğŸ” Issue Information
        run: |
          echo "=== ISSUE DEBUG INFORMATION ==="
          echo "Issue Number: ${{ github.event.issue.number }}"
          echo "Issue Title: ${{ github.event.issue.title }}"
          echo "Issue Action: ${{ github.event.action }}"
          echo "Issue State: ${{ github.event.issue.state }}"
          echo ""
          
      - name: ğŸ“‹ Show Issue Body Raw
        run: |
          echo "=== RAW ISSUE BODY ==="
          cat << 'EOF'
          ${{ github.event.issue.body }}
          EOF
          echo ""
          echo "=== END RAW ISSUE BODY ==="
          
      - name: ğŸ§ª Test Challenge-ID Extraction
        run: |
          echo "=== CHALLENGE-ID EXTRACTION TESTS ==="
          
          # Issue-Body in Variable speichern
          ISSUE_BODY='${{ github.event.issue.body }}'
          
          echo "ğŸ“ Issue Body Length: ${#ISSUE_BODY} characters"
          echo ""
          
          echo "ğŸ§ª Test 1: Suche nach **ID:** Pattern"
          echo "$ISSUE_BODY" | grep -n "ID:" || echo "Kein ID: gefunden"
          echo ""
          
          echo "ğŸ§ª Test 2: Alle **..:** Patterns"
          echo "$ISSUE_BODY" | grep -n "\*\*.*:\*\*" || echo "Keine **...:** Patterns gefunden"
          echo ""
          
          echo "ğŸ§ª Test 3: Zeilen mit 'mcbt'"  
          echo "$ISSUE_BODY" | grep -n "mcbt" || echo "Kein 'mcbt' gefunden"
          echo ""
          
          echo "ğŸ§ª Test 4: Extraction Method 1"
          ID1=$(echo "$ISSUE_BODY" | grep -oE '\*\*ID:\*\*[[:space:]]*[a-zA-Z0-9_-]+' | sed 's/.*\*\*ID:\*\*[[:space:]]*//' | head -1 | xargs 2>/dev/null || echo "")
          echo "Method 1 Result: '$ID1'"
          
          echo "ğŸ§ª Test 5: Extraction Method 2 (simple grep)"
          ID2=$(echo "$ISSUE_BODY" | grep -o "balanced-binary-search-tree-validator-mcbt0fnk" || echo "")
          echo "Method 2 Result: '$ID2'"
          
          echo "ğŸ§ª Test 6: Find any mcbt pattern"
          ID3=$(echo "$ISSUE_BODY" | grep -oE '[a-zA-Z0-9-]*mcbt[a-zA-Z0-9]+' | head -1 || echo "")
          echo "Method 3 Result: '$ID3'"
          
          echo "ğŸ§ª Test 7: Manual search for the specific ID"
          if echo "$ISSUE_BODY" | grep -q "balanced-binary-search-tree-validator-mcbt0fnk"; then
            echo "âœ… Found specific ID: balanced-binary-search-tree-validator-mcbt0fnk"
            FINAL_ID="balanced-binary-search-tree-validator-mcbt0fnk"
          else
            echo "âŒ Specific ID not found"
            FINAL_ID=""
          fi
          
          echo ""
          echo "ğŸ“Š FINAL RESULT:"
          if [ -n "$FINAL_ID" ]; then
            echo "âœ… Challenge-ID: $FINAL_ID"
          else
            echo "âŒ No Challenge-ID found"
          fi
          
      - name: ğŸ“‚ Check Repository Structure
        run: |
          echo "=== REPOSITORY STRUCTURE ==="
          echo "ğŸ“ Current directory:"
          pwd
          ls -la
          echo ""
          
          echo "ğŸ“ Check if challenges folder exists:"
          if [ -d "challenges" ]; then
            echo "âœ… challenges/ folder exists"
            echo "ğŸ“ Contents of challenges/:"
            ls -la challenges/
            
            echo ""
            echo "ğŸ” Look for the specific challenge:"
            if [ -d "challenges/balanced-binary-search-tree-validator-mcbt0fnk" ]; then
              echo "âœ… Challenge folder exists: challenges/balanced-binary-search-tree-validator-mcbt0fnk"
              echo "ğŸ“ Contents:"
              ls -la "challenges/balanced-binary-search-tree-validator-mcbt0fnk/"
              
              if [ -f "challenges/balanced-binary-search-tree-validator-mcbt0fnk/challenge.json" ]; then
                echo "âœ… challenge.json exists"
                echo "ğŸ“„ Current content:"
                cat "challenges/balanced-binary-search-tree-validator-mcbt0fnk/challenge.json"
              else
                echo "âŒ challenge.json missing"
              fi
            else
              echo "âŒ Challenge folder does not exist"
              echo "ğŸ” Available challenges:"
              find challenges/ -maxdepth 1 -type d 2>/dev/null | head -10
            fi
          else
            echo "âŒ challenges/ folder does not exist"
          fi
          
      - name: ğŸ› ï¸ Test jq availability
        run: |
          echo "=== JQ TEST ==="
          if command -v jq >/dev/null 2>&1; then
            echo "âœ… jq is available"
            jq --version
          else
            echo "âŒ jq is not available"
            echo "Available tools:"
            which grep sed awk || echo "Basic tools check"
          fi
          
      - name: ğŸ’¬ Report Results
        uses: actions/github-script@v7
        with:
          script: |
            const issueBody = `${{ github.event.issue.body }}`;
            const hasSpecificId = issueBody.includes('balanced-binary-search-tree-validator-mcbt0fnk');
            const hasIdPattern = issueBody.includes('**ID:**');
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ” Debug Results fÃ¼r Issue #${context.issue.number}
              
              **Issue Debug:** Challenge-ID Extraktion getestet
              
              ### ğŸ“Š Ergebnisse:
              - âœ… Issue Body contains specific ID: \`${hasSpecificId}\`
              - âœ… Issue Body contains **ID:** pattern: \`${hasIdPattern}\`
              - âœ… Issue Body length: ${issueBody.length} characters
              
              ### ğŸ” Expected Challenge-ID:
              \`balanced-binary-search-tree-validator-mcbt0fnk\`
              
              ### ğŸ“‹ Next Steps:
              Check the workflow logs in the [Actions tab](https://github.com/${context.repo.owner}/${context.repo.repo}/actions) to see:
              1. If the Challenge-ID was extracted correctly
              2. If the challenge folder exists in the repository
              3. If jq tool is available for JSON processing
              
              ---
              ğŸ¤– *Debug workflow completed - check logs for details*`
            });
